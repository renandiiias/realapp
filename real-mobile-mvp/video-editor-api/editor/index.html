<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real | Editor Manual</title>
    <style>
      :root {
        --real-green: #35e214;
        --real-purple: #8e00a6;
        --real-black: #1a1a1a;
        --real-gray: #ededee;
      }
      body {
        margin: 0;
        font-family: Montserrat, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--real-gray);
        background: radial-gradient(circle at 20% 10%, #263211 0%, #111111 44%, #0b0b0c 100%);
      }
      .wrap {
        padding: 16px;
        max-width: 980px;
        margin: 0 auto;
      }
      .card {
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 14px;
        background: rgba(8, 8, 8, 0.78);
        padding: 14px;
        margin-bottom: 14px;
      }
      h1 {
        margin: 0 0 6px;
        font-size: 20px;
      }
      p {
        margin: 0;
        color: #c9c9cc;
      }
      video {
        width: 100%;
        aspect-ratio: 9 / 16;
        background: #000;
        border-radius: 12px;
      }
      .grid {
        display: grid;
        gap: 10px;
      }
      label {
        font-size: 13px;
        color: #bdbdc2;
      }
      input[type="range"] {
        width: 100%;
        accent-color: var(--real-green);
      }
      .row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }
      .btn {
        border: 0;
        border-radius: 10px;
        padding: 12px 14px;
        font-weight: 700;
        cursor: pointer;
      }
      .btn-primary {
        background: linear-gradient(100deg, var(--real-green), #7df36b);
        color: #10230a;
      }
      .btn-secondary {
        background: #1f1f22;
        color: #efeff1;
        border: 1px solid rgba(255, 255, 255, 0.15);
      }
      .kvs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        font-size: 13px;
      }
      .status {
        margin-top: 8px;
        color: #c8f8be;
      }
      @media (max-width: 640px) {
        .kvs {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Editor manual da Real</h1>
        <p>Se o corte automatico nao ficou ideal, ajuste inicio/fim e exporte sem sair do app.</p>
      </div>

      <div class="card">
        <video id="player" controls playsinline></video>
      </div>

      <div class="card grid">
        <div>
          <label for="startRange">Inicio</label>
          <input id="startRange" type="range" min="0" max="0" step="0.1" value="0" />
        </div>
        <div>
          <label for="endRange">Fim</label>
          <input id="endRange" type="range" min="0" max="0" step="0.1" value="0" />
        </div>
        <div class="row">
          <label><input id="subtitleToggle" type="checkbox" checked /> Reaplicar legenda automatica</label>
          <span id="durationLabel">0.0s</span>
        </div>
        <div class="kvs">
          <div><b>Inicio:</b> <span id="startLabel">0.0s</span></div>
          <div><b>Fim:</b> <span id="endLabel">0.0s</span></div>
          <div><b>Janela:</b> <span id="windowLabel">0.0s</span></div>
          <div><b>Video:</b> <span id="videoLabel">-</span></div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <button class="btn btn-secondary" id="previewBtn">Preview do recorte</button>
          <button class="btn btn-primary" id="exportBtn">Exportar versao manual</button>
        </div>
        <div class="status" id="status"></div>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const videoId = params.get("videoId") || "";
      const token = params.get("token") || "";
      const apiBase = `${window.location.origin}`;

      const player = document.getElementById("player");
      const startRange = document.getElementById("startRange");
      const endRange = document.getElementById("endRange");
      const subtitleToggle = document.getElementById("subtitleToggle");
      const durationLabel = document.getElementById("durationLabel");
      const startLabel = document.getElementById("startLabel");
      const endLabel = document.getElementById("endLabel");
      const windowLabel = document.getElementById("windowLabel");
      const status = document.getElementById("status");
      const videoLabel = document.getElementById("videoLabel");

      const updateLabels = () => {
        const s = Number(startRange.value || 0);
        const e = Number(endRange.value || 0);
        startLabel.textContent = `${s.toFixed(1)}s`;
        endLabel.textContent = `${e.toFixed(1)}s`;
        windowLabel.textContent = `${Math.max(0, e - s).toFixed(1)}s`;
      };

      const postNative = (payload) => {
        if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
          window.ReactNativeWebView.postMessage(JSON.stringify(payload));
        }
      };

      const setStatus = (txt) => {
        status.textContent = txt;
      };

      const clampRanges = () => {
        const start = Number(startRange.value || 0);
        const end = Number(endRange.value || 0);
        if (start > end - 0.1) {
          if (document.activeElement === startRange) {
            endRange.value = String(Math.min(Number(endRange.max), start + 0.1));
          } else {
            startRange.value = String(Math.max(Number(startRange.min), end - 0.1));
          }
        }
        updateLabels();
      };

      const loadVideo = async () => {
        if (!videoId || !token) {
          setStatus("Sessao invalida.");
          return;
        }
        videoLabel.textContent = videoId;
        player.src = `${apiBase}/v1/videos/${videoId}/content`;
        const videoMeta = await fetch(`${apiBase}/v1/videos/${videoId}`);
        const data = await videoMeta.json();
        if (!videoMeta.ok) {
          setStatus(data.detail || "Falha ao carregar video.");
          return;
        }
        const progress = Math.round((data.progress || 0) * 100);
        setStatus(`Video carregado. Status: ${data.status}. Progresso: ${progress}%`);
      };

      player.addEventListener("loadedmetadata", () => {
        const duration = Number(player.duration || 0);
        durationLabel.textContent = `${duration.toFixed(1)}s`;
        startRange.max = String(duration);
        endRange.max = String(duration);
        endRange.value = String(duration);
        updateLabels();
      });

      startRange.addEventListener("input", clampRanges);
      endRange.addEventListener("input", clampRanges);

      document.getElementById("previewBtn").addEventListener("click", () => {
        const s = Number(startRange.value || 0);
        const e = Number(endRange.value || 0);
        player.currentTime = s;
        player.play();
        const timer = setInterval(() => {
          if (player.currentTime >= e) {
            player.pause();
            clearInterval(timer);
          }
        }, 100);
      });

      document.getElementById("exportBtn").addEventListener("click", async () => {
        const start = Number(startRange.value || 0);
        const end = Number(endRange.value || 0);
        setStatus("Enviando exportacao manual...");
        postNative({ type: "manual_export_started", videoId, start, end });
        const response = await fetch(`${apiBase}/v1/videos/${videoId}/manual-export`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            token,
            start_seconds: start,
            end_seconds: end,
            include_subtitles: subtitleToggle.checked,
          }),
        });
        const data = await response.json();
        if (!response.ok) {
          setStatus(data.detail || "Falha na exportacao manual.");
          postNative({ type: "manual_export_failed", videoId, error: data.detail || "manual_export_failed" });
          return;
        }
        const newVideoId = data?.video?.id || "";
        setStatus(`Exportacao iniciada: ${newVideoId}`);
        postNative({ type: "manual_export_queued", baseVideoId: videoId, videoId: newVideoId });
      });

      loadVideo();
      updateLabels();
    </script>
  </body>
</html>
